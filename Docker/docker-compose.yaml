services:
  redis:
    image: "redis:alpine"
    ports:
      - "6380:6379"

  api:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.api
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app/src
      - ./config:/app/config
      - ./env:/app/env
      - ./data/results:/app/data/results
      - ./tests:/app/tests
    depends_on:
      - redis
    env_file:
      - env/local.properties
    environment:
      - REDIS_HOST=redis
      - USE_REDIS=true

  worker:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.worker
    ports:
      - "5901:5900" # Map Docker VNC (5900) to host port 5901 to avoid conflicts
      - "5679:5679" # Expose debug port
    volumes:
      - ./src:/app/src
      - ./config:/app/config
      - ./env:/app/env
      - ./scripts:/app/scripts
      - ./data/results:/app/data/results
    depends_on:
      - redis
    env_file:
      - env/local.properties
    environment:
      - REDIS_HOST=redis
      - USE_REDIS=true
      - ENABLE_VNC=true # Set to false in production
      - PROXY_SERVER=${PROXY_SERVER}
      - PROXY_USERNAME=${PROXY_USERNAME}
      - PROXY_PASSWORD=${PROXY_PASSWORD}
      # Azure credentials loaded from env/local.properties
    shm_size: '2gb'

  frontend:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.frontend
    ports:
      - "8501:8501"
    volumes:
      - ./src:/app/src
      - ./config:/app/config
    depends_on:
      - api
      - redis
    environment:
      - API_URL=http://api:8000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
